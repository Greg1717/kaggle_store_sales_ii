---
title: "Kaggle Store Sales"
output: html_notebook
---


# Short Solution

```{r}
# url_short_solution <- "https://www.kaggle.com/code/coolman145/simple-baseline-r-forecasting-with-fable-0-42401"
# 
# # Import Data =================================================================
# suppressMessages(library(tidyverse))
# suppressMessages(library(tsibble))
# suppressMessages(library(fable))
# 
# train = read_csv('./data/train.csv')
# test = read_csv('./data/test.csv')
# 
# # train model =================================================================
# pred <- train %>%
#   tsibble(index = date, key = c(store_nbr, family)) %>%
#   fill_gaps(sales = 0) %>%
#   model(ets = ETS(sqrt(sales))) %>%
#   forecast(h = "16 days")
# 
# write_csv(pred, file = "pred.csv")
# 
# ## Export Test Data Results ===================================================
# results <- test %>%
#   left_join(pred, by = c("store_nbr", "family", "date")) %>%
#   select(id, .mean)
# 
# colnames(results) <- c("id","sales")
# 
# write_csv(results, file = "submission.csv")
```

# Load Packages and Data
```{r}
library(tidyverse)
library(tsibble)
library(fable)
library(fpp3)
train = read_csv('./data/train.csv')
test = read_csv('./data/test.csv')
```

# EDA
```{r}
str(train)
```
Convert to tsibble:
```{r}
train <- tsibble(train, index = date, key = c(store_nbr, family))
str(train, max.level = 2)
```

```{r}
# review zero sales; do we need these rows?; we clean it up later with fill_gaps()
arrange(train[train$sales == 0,], store_nbr)
```


```{r}
summary(train)
```

```{r}
table(train$family)
```
```{r}
head(train)
```

## Plot
### Aggregate Sales and Plot TS
```{r}
train |>
  # group_by(family) |>
  index_by(date) |>
  summarise(sales = sum(sales))
```

```{r}
train |>
  summarise(sales = sum(sales)) |>
  autoplot(.vars = sales) +
  labs(title = "Sales",
       subtitle = "Consolidated",
       x = "Date",
       y = "Sales")
```

### Decompose
```{r}
train_consolidated <- 
  train |>
  summarise(sales = sum(sales)) |>
  fill_gaps(sales = 0)

train_consolidated[train_consolidated$sales == 0,]

dcmp <- train_consolidated |>
  model(stl = STL(sales))

components(dcmp) |>
  autoplot()

is.ts(train_consolidated)
is.ts(us_employment)
is_tsibble(us_employment)
frequency(us_employment)
frequency(train_consolidated)
us_employment

  # model(STL(sales)) |>
  # components()
```

# Train Model


# Prediction


# Create Submission File